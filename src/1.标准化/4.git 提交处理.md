# git pre-commit

Git 有很多的 hooks，让我们在不同的阶段，对代码进行不同的操作，控制提交到仓库的代码的规范性,和准确性，以下只是几个常用的钩子：

- **pre-commit**：判断提交的代码是否符合规范。
- **commit-msg**：判断 commit 信息是否符合规范。

## 1.工具

**husky**：操作 git 钩子的工具。

通过以下命令进行安装：

```shell
npm i husky -D
```

## 2.pre-commit

在 git 提交的 **pre-commit** 阶段，对暂存的文件，进行校验及格式化，确保提交的代码或文件满足相应的规范。

此处我们需要 **lint-staged** 工具，该工具结合 **husky** 让我们可以对已暂存的文件进行相应的处理。

### 安装

```shell
npm i lint-staged -D
```

依次执行以下命令：

```shell
# 在package.json中添加脚本
npm set-script prepare "husky install"
# 初始化 husky，将 git hooks 钩子交由，husky 执行
npm run prepare
```

此时，会在根目录创建 **.husky** 文件夹，继续执行以下命令：

```shell
npx husky add .husky/pre-commit "npx lint-staged"
```

这个时候，会在 **.husky** 文件下，新增 **pre-commit** 文件，在 git 提交的 **pre-commit** 阶段，执行 **npx lint-staged** 命令，对暂存的文件进行处理。

此时，我们只配置了对暂存文件需要处理，但怎么处理，还未进行声明。

在根目录下，新增 **.lintstagedrc.json** 文件，用于控制对文件进行如何处理。（也可在 **package.json** 文件下，增加 **lint-staged** 属性，进行配置）

```json
{
  "*.{js,ts}": ["prettier --write .", "eslint --fix"],
  "*.md": ["prettier --write"]
}
```

上述文件，声明对：

- 对 JS 及 TS 文件，先进行 **prettier** 处理，再进行 **eslint** 处理。
- 对 MD 文件，进行 **prettier** 处理。

## 3.commit-msg

**commit-msg** 时可以对提交的信息进行校验，保证提交信息的风格统一。

### 安装

```shell
npm i commitlint @commitlint/config-conventional -D
npx husky add .husky/commit-msg 'npx --no-install commitlint --edit "$1"'
```

- [commitlint](https://github.com/conventional-changelog/commitlint)：git commit 时对于 commit message 进行规范检查的工具，保证团队的一致性。
- [@commitlint/config-conventional](https://github.com/conventional-changelog/commitlint)：这是一个规范配置，标识采用什么规范来执行消息校验。

| Type     | 作用                                                                                   |
| -------- | -------------------------------------------------------------------------------------- |
| feat     | 新增特性 (feature)                                                                     |
| fix      | 修复 Bug(bug fix)                                                                      |
| docs     | 修改文档 (documentation)                                                               |
| style    | 代码格式修改(white-space, formatting, missing semi colons, etc)                        |
| refactor | 代码重构(refactor)                                                                     |
| perf     | 改善性能(A code change that improves performance)                                      |
| test     | 测试(when adding missing tests)                                                        |
| build    | 变更项目构建或外部依赖（例如 scopes: webpack、gulp、npm 等）                           |
| ci       | 更改持续集成软件的配置文件和 package 中的 scripts 命令，例如 scopes: Travis, Circle 等 |
| chore    | 变更构建流程或辅助工具(比如更改测试环境)                                               |
| revert   | 代码回退                                                                               |

在 根目录下，创建 **commitlint.config.js** 文件，用于配置 **commitlint**。

```js
module.exports = {
  extends: ['@commitlint/config-conventional'],
};
```

## 4.命令式提交

完成上述步骤，git 提交时，已经会对提交的信息进行校验，继续通过 **commitizen** 实现命令行方式的提交。

### commitizen

**commitizen**：基于 Node.js 的 `git commit` 命令行工具，辅助生成标准化规范化的 commit message。

#### 安装

```shell
npm install -D commitizen
```

### cz-git

安装完成后，我们还需一个**适配器**去优化流程。

**adapter(适配器)** : 更换 commitizen 命令行工具的**交互方式**插件。

> [cz-git 介绍](https://cz-git.qbb.sh/zh/guide/)

#### 安装

```shell
npm install -D cz-git
```

#### 适配器配置

在 **package.json** 文件中，添加 **config** 指定使用的适配器。

```json
{
  // ...
  "config": {
    "commitizen": {
      "path": "node_modules/cz-git"
    }
  }
}
```

#### 自定义配置

在 [commitlint](https://github.com/conventional-changelog/commitlint#config) 配置文件之中，可以增加更多的自定义配置，详情参考：

> [配置模板](https://cz-git.qbb.sh/zh/config/)

#### 其它适配器

- cz-conventional-changelog：commitizen 官方的适配器
- cz-customizable：可支持自定义的适配器

> [对比说明](https://blog.qbb.sh/post/2022/02/27/cz-git/#%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%8D%E4%BD%BF%E7%94%A8)

### 提交

在 **package.json** 中，**scripts** 下添加命令，即可通过命令快速填写符合规范的 commit 信息。

```json
{
  "scripts": {
    "commit": "git cz"
  }
}
```
